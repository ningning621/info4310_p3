<!DOCTYPE html>
<html lang = "en">
<head>
  <meta charset="UTF-8" />
  <link rel="shortcut icon" href="#"/>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>

  <title>Pittsburgh Itinerary, Exclusively Yours</title>

  <style>
    body {
      font-family: 'Lato', 'Helvetica', sans-serif;
      font-weight: 400;
    }

    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .neighborhood {
      fill: #EEE;
      stroke: white;
      stroke-width: 2px;
    }

    #tinder{
      display: flex;
      flex-direction: row;
    }

  </style>
</head>

<body>
  <h1>Pittsburgh Itinerary, Exclusively Yours</h1>
  <div id="tinder">
  <div>
  <svg id="pittsburghmap" height="750" width="750" style="background: #fff; margin-top:50px" >
  </div>
  <div id="matching">
    <h2>Go through the set of Pittsburgh locations recommended based on your preferred vibes!</h2>
    <button href="#" id="start">Start!</button>
  </div>
  </div>

  <script>
  const svg = d3.select("#pittsburghmap");
  const width = svg.attr("width");
  const height = svg.attr("height");
  const margin = { top: 20, right: 20, bottom: 20, left:20};
  const mapWidth = width - margin.left - margin.right;
  const mapHeight = height - margin.top - margin.bottom;
  const map = svg.append("g")
                  .attr("transform","translate("+margin.left+","+margin.top+")");

  // let data = {"name":["21st Street Coffee And Tea","A & B Doughnuts", "location 3"] , "url":["http://www.yelp.com/biz/21st-street-coffee-and-tea-pittsburgh-2?utm_campaign=yelp_api&utm_medium=api_v2_business&utm_source=ERehee8c-xBF5R86JGKbYg", "http://www.yelp.com/biz/a-and-b-doughnuts-homestead?utm_campaign=yelp_api&utm_medium=api_v2_business&utm_source=ERehee8c-xBF5R86JGKbYg", "www.google.com"], "review count":[36,2,3], "rating":[4,5,3], "neighborhood":["Downtown", "Homestead", "test 3"] , "latitude":[40.44131, 40.40867615, 50], "longitude":[-80.00121, -79.90471649, -75], "category":["coffee", "donuts", "life"], "type":["food","food", "life"]};

  let data = [{"name":"21st Street Coffee And Tea", "url":"http://www.yelp.com/biz/21st-street-coffee-and-tea-pittsburgh-2?utm_campaign=yelp_api&utm_medium=api_v2_business&utm_source=ERehee8c-xBF5R86JGKbYg", "review count":36, "rating":4, "neighborhood":"Downtown" , "latitude":40.44131, "longitude":-80.00121, "category":"coffee", "type":"food"}, {"name":"A & B Doughnuts", "url":"http://www.yelp.com/biz/a-and-b-doughnuts-homestead?utm_campaign=yelp_api&utm_medium=api_v2_business&utm_source=ERehee8c-xBF5R86JGKbYg", "review count":2, "rating":5, "neighborhood":"Homestead", "latitude":40.40867615, "longitude":-79.90471649, "category":"donuts", "type":"food"}, {"name":"location 3" , "url":"www.google.com", "review count":3, "rating":3, "neighborhood":"test 3", "latitude":40.428219, "longitude":-79.97583, "category":"life", "type":"life"}];

  // console.log(data);

  const requestData = async function() {
    const pittsburgh = await d3.json("./datasets/pittsburgh_neighborhoods.json");

    var neighborhoods = topojson.feature(pittsburgh, pittsburgh.objects.Neighborhoods_);
    console.log(neighborhoods);

    // We use Mercator projection instead of a "better" projection because it's more familiar
    // It also leads to a flat line on the bottom of the city due to how the projection makes all
    //  latitude lines flat (which allows rhumb line equivalency)
    var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods);
    var path = d3.geoPath().projection(projection);

    // Draw neighborhoods
    // Just as in our line generators, the scale is used by the generator to take complex data and
    //  generate fancy paths
    map.selectAll("path.neighborhood").data(neighborhoods.features)
      .join("path")
      .attr("class", "neighborhood")
      .attr("d", path);

    // initiate the matching process
    document.getElementById("start").onclick = function() {
      nextRecommendation(0);
      return false;
    };

    //initialize an empty dictionary for results
    result = []

    data.forEach(d => {
      d.Position = projection([d.longitude, d.latitude]);
    })

    function nextRecommendation(num) {
      var name = data[num]['name'];
      var url = data[num]['url'];
      var reviewCount = data[num]['review count'];
      var neighborhood = data[num]['neighborhood'];
      var rating = data[num]['rating'];
      var latitude = data[num]["latitude"];
      var longitude = data[num]["longitude"];
      var category = data[num]["category"];
      var type = data[num]["type"];

      var prompt = d3.select("#matching");
      prompt.html("");
      prompt.append("h2").attr("id", "question").html(name);
      prompt.append("h2").attr("id", "url").html(url);
      prompt.append("h2").attr("id", "rating").html(rating);

       map.selectAll('.poi')
          .data(data)
          .enter()
          .append('image')
          .attr("class", "poi")
          .attr('xlink:href','mapmarker.png')
          .attr("x", d => d.Position[0] - 10) // slight adjustment bc image starts from top-left
          .attr("y", d => d.Position[1] - 10) // slight adjustment bc image starts from top-left
          .attr("opacity", 1)
          .attr("width", 20)
          .attr("height", 20)

      map.append('text')
         .text(name)
         .attr('id', 'temp-label')
         .attr('text-anchor', 'middle')
         .attr('font-size', '10px')
         .attr('font-weight', 400)
         .attr('x', data[num].Position[0])
         .attr('y', data[num].Position[1] - 20);

      //yes and no buttons
      var yes = prompt.append("input")
                      .attr("type", "button")
                      .attr("class", "selection")
                      .attr("value", "Yes, I would love to visitðŸ¤©");

      var no = prompt.append("input")
                     .attr("type", "button")
                     .attr("class", "selection")
                     .attr("value", "Nah, not for meðŸ¤§");

      //if clicking on yes, add the data to the dictionary for final result, proceed to next question
      yes.on("click", function(d, i) {

          result.push(data[num]);

          if (num < data.length-1) {

              d3.select('#temp-label').remove();
              nextRecommendation(num+1);

          }
          else {

              d3.select('#temp-label').remove();
              finishRecommendation();

          }
      });

      //if clicking on no, proceed to next question
      no.on("click", function(d, i){

        if (num < data.length-1){

          d3.select('#temp-label').remove();
          nextRecommendation(num+1);

        }
        else{

          d3.select('#temp-label').remove();
          finishRecommendation();

        }

      });

    }

    // finish the recommendation process
    function finishRecommendation(){
      console.log(result);

      d3.select("#matching")
        .html("<h2>Check out your Pittsburgh itinerary!</h2>"+
        "<button href=\"#\" id='restart'>Generate new itineraryðŸ™Œ</button>");
        //But what about generating a new set of recommendations??

      map.selectAll("image").remove();

      map.selectAll('.poi')
         .data(result)
         .enter()
         .append('image')
         .attr("class", "poi")
         .attr('xlink:href','mapmarker.png')
         .attr("x", d => d.Position[0] - 10) // slight adjustment bc image starts from top-left
         .attr("y", d => d.Position[1] - 10) // slight adjustment bc image starts from top-left
         .attr("opacity", 1)
         .attr("width", 20)
         .attr("height", 20)

      result.forEach((d, i) =>{


        map.append('text')
           .text(d.name)
           .attr('text-anchor', 'middle')
           .attr('font-size', '10px')
           .attr('font-weight', 400)
           .attr('x', d.Position[0])
           .attr('y', d.Position[1] - 20);

      });

      d3.select("#restart")
        .on("click", function() {

          d3.selectAll('image').remove();
          d3.selectAll('text').remove();
          nextRecommendation(0);
          result = [];
          return false;

      })
    }
  }
  requestData();





  </script>
</body>
</html>
